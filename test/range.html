<!doctype html>
<html>
<head>
	<title>cosmoz-omnitable range tests for number and amount</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

	<script src="../../webcomponentsjs/webcomponents-lite.js"></script>
	<script src="../../web-component-tester/browser.js"></script>
	<script src="../../test-fixture/test-fixture-mocha.js"></script>

	<link rel="import" href="../../test-fixture/test-fixture.html">
	<link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">

	<link rel="import" href="../cosmoz-omnitable.html">
	<link rel="import" href="../cosmoz-omnitable-columns.html">
	<link rel="import" href="../demo/table-demo-behavior.html">
</head>
<body>
	<test-fixture id="range">
		<template>
			<cosmoz-omnitable id="omnitable" class="flex">
				<cosmoz-omnitable-column-number title="Age" name="age" value-path="age">
				</cosmoz-omnitable-column-number>
				<cosmoz-omnitable-column-amount title="Amount" name="amount" value-path="amount">
				</cosmoz-omnitable-column-amount>
				<cosmoz-omnitable-column-date title="Date" name="date" value-path="date" editable>
				</cosmoz-omnitable-column-date>
				<cosmoz-omnitable-column-datetime title="Datetime" name="datetime" value-path="date" editable>
				</cosmoz-omnitable-column-datetime>
				<cosmoz-omnitable-column-time title="Time" name="time" value-path="time" editable>
				</cosmoz-omnitable-column-time>
			</cosmoz-omnitable>
		</template>
	</test-fixture>

	<script>
	/*global sinon chai flush */
	(function () {
		'use strict';
		const data = [
			{ age: 17,
				amount: { amount: '12.4', currency: 'USD' },
				date: new Date(2023, 3, 24),
				time: ''
			},
			{ amount: { amount: 2 },
				date: new Date('2015-03-18'),
				time: '00:00'
			},
			{ age: -11,
				amount: { amount: 678, currency: 'AUD' },
				date: new Date(86400000), // Fri Jan 02 1970 02:00:00 GMT+0200 (EET)
				time: '10:17'
			},
			{ age: 9,
				amount: { amount: -8, currency: 'EUR' },
				date: new Date(99, 5, 24, 11, 33, 30, 0), // Thu Jun 24 1999 11:33:30 GMT+0300 (EEST)
				time: '11:00'
			},
			{
				age: 5,
				amount: { amount: '3450', currency: 'DKK' },
				date: new Date('2016-08-27'),
				time: '17:34'
			},
		];

		sinon.assert.expose(chai.assert, { prefix: '' });

		suite('number', function () {
			let omnitable,
				column;

			setup(function (done) {
				omnitable = fixture('range');
				omnitable.data = data;
				Polymer.Base.async(function () {
					column = omnitable.columns[0];
					done();
				}, 90);
			});

			test('instantiates a cosmoz-omnitable-column-number', function (done) {
				assert.equal(column.is, 'cosmoz-omnitable-column-number');
				done();
			});

			test('toNumber convers a value to Number', function (done) {
				assert.isUndefined(column.toNumber());
				assert.equal(column.toNumber(-7.5), -7.5);
				assert.equal(column.toNumber('-7.5'), -7.5);
				assert.equal(column.toNumber(123e-5), 0.00123);
				assert.isNotNumber(column.toNumber('some string not number'));
				done();
			});

			test('toNumber limits parameters', function (done) {
				assert.equal(column.toNumber('-2.0014', 4), -2.0014);
				assert.equal(column.toNumber(3, 2, Math.min), 2);
				assert.equal(column.toNumber('23.3', '-10.5443', Math.min), -10.5443);
				assert.equal(column.toNumber(3, '2.0014', Math.min), 2.0014);
				assert.equal(column.toNumber(3, 2.0014, Math.max), 3);
				done();
			});

			test('computes range from values', function (done) {
				assert.isObject(column._range);
				assert.equal(column._range.min, -11);
				assert.equal(column._range.max, 17);
				done();
			});

			test('returns the value of an item', function (done) {
				assert.equal(column.getComparableValue(data[0], 'age'), 17);
				assert.equal(column.getComparableValue(data[1], 'age'), null);
				assert.equal(column.getComparableValue(data[2], 'age'), -11);
				done();
			});

			test('changing filter updates _filterInput', function (done) {
				assert.isNull(column.filter.min);
				assert.isNull(column.filter.max);
				column.filter = {
					min: 3,
					max: 200
				};
				assert.equal(column._filterInput.min, 3);
				assert.equal(column._filterInput.max, 200);
				done();
			});

			test('changing _filterInput updates filter', function (done) {
				assert.isNull(column._filterInput.min);
				assert.isNull(column._filterInput.max);
				column._filterInput = {
					min: -10,
					max: 15
				};
				Polymer.Base.async(function () {
					assert.equal(column.filter.min, -10);
					assert.equal(column.filter.max, 15);
					done();
				}, 650);
			});

			test('changing only _filterInput min updates filter min', function (done) {
				column._filterInput.min = -21;
				Polymer.Base.async(function () {
					assert.equal(column.filter.min, -21);
					done();
				}, 650);
			});

		});

		suite('amount', function () {
			let omnitable,
				column;

			setup(function (done) {
				omnitable = fixture('range');
				omnitable.data = data;
				Polymer.Base.async(function () {
					column = omnitable.columns[1];
					done();
				}, 120);
			});

			test('instantiates a cosmoz-omnitable-column-amount', function (done) {
				assert.equal(column.is, 'cosmoz-omnitable-column-amount');
				done();
			});

			test('toAmount returns default currency', function (done) {
				assert.equal(column.toAmount(123).currency, 'SEK');
				assert.equal(column.toAmount(data[1].amount).currency, 'SEK');
				done();
			});

			test('toAmount returns the specificated currency', function (done) {
				assert.equal(column.toAmount(data[0].amount).currency, 'USD');
				assert.equal(column.toAmount(data[2].amount).currency, 'AUD');
				assert.equal(column.toAmount(data[3].amount).currency, 'EUR');
				done();
			});

			test('toAmount converts a amount to a number', function (done) {
				assert.equal(column.toAmount(123).amount, 123);
				assert.equal(column.toAmount('2300').amount, 2300);
				assert.isObject(column.toAmount(data[0].amount)); // amount is Object
				assert.equal(column.toAmount(data[0].amount).amount, 12.4); // string value to number
				done();
			});

			test('toAmount limits parameters value', function (done) {
				assert.equal(column.toAmount('-2.0014', 4).amount, -2.0014);
				assert.equal(column.toAmount(3, 2, Math.min).amount, 2);
				assert.equal(column.toAmount('23.3', '-10.5443', Math.min).amount, -10.5443);
				assert.equal(column.toAmount(3, '2.0014', Math.min).amount, 2.0014);
				assert.equal(column.toAmount(3, 2.0014, Math.max).amount, 3);
				done();
			});

			test('returns comparable value', function (done) {
				assert.equal(column.getComparableValue(data[3], 'amount'), -8);
				assert.equal(column.getComparableValue(data[4], 'amount'), 3450);
				done();
			});

			test('amount renders symbol and value', function (done) {
				assert.equal(column.renderValue(data[0].amount), '$12.40');
				assert.equal(column.renderValue(data[1].amount), 'Invalid value', 'Expected missing currency to be treated as invalid.');
				assert.equal(column.renderValue(data[3].amount), '-â‚¬8.00');
				done();
			});

			test('computes array of formaters', function (done) {
				assert.deepEqual(Object.keys(column._formatters), ['SEK', 'USD', 'AUD', 'EUR', 'DKK']);
				done();
			});

		});
	}());

	</script>
</body>
</html>
